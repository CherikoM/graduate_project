<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project.dao.StyleHistoryDAO">
    <resultMap id="styleHistoryResultMap" type="com.example.project.dataobject.StyleHistoryDO">
        <id column="id" property="id"/>
        <result column="is_new" property="isNew"/>
        <result column="style_id" property="styleId"/>
        <result column="style_en_name" property="styleEnName"/>
        <result column="change" property="change"/>
        <result column="user_id" property="userId"/>
        <result column="user_name" property="userName"/>
        <result column="info" property="info"/>
        <result column="reference" property="reference"/>
        <result column="auditor_id" property="auditorId"/>
        <result column="is_pass" property="isPass"/>
        <result column="audit_time" property="auditTime"/>
        <result column="thanks" property="thanks"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <insert id="addStyleVersion" parameterType="com.example.project.dataobject.StyleHistoryDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `style_history`(`is_new`,`style_id`,`style_en_name`,`change`,`user_id`,`user_name`,`info`,`reference`,`auditor_id`,`is_pass`,`thanks`)
        VALUES (#{isNew},#{styleId},#{styleEnName},#{change},#{userId},#{userName},#{info},#{reference},#{auditorId},#{isPass},#{thanks});
    </insert>

    <select id="getNotAuditStyleVersion" resultMap="styleHistoryResultMap">
        select * from `style_history` where is_pass = 0
    </select>

    <select id="isAudit" resultType="Integer">
        <if test="styleHistoryId!=null">
            select `is_pass` from `style_history` where id=#{styleHistoryId}
        </if>
    </select>

    <update id="updateStyleVersion" parameterType="com.example.project.dataobject.StyleHistoryDO">
        <if test="id!=null">
            update `style_history`
            <set>
                <if test="styleId!=null">
                    style_id=#{styleId},
                </if>
                <if test="auditorId!=null">
                    auditor_id=#{auditorId},
                </if>
                <if test="isPass!=null">
                    <if test="isPass==1 or isPass==2">
                        is_pass=#{isPass},
                    </if>
                </if>
                audit_time=now(),
                <if test="thanks!=null">
                    thanks=#{thanks},
                </if>
            </set>
            <where>
                id = #{id};
            </where>
        </if>
    </update>

    <select id="getAllStyleVersion" resultMap="styleHistoryResultMap">
        <if test="styleName!=null">
            select * from `style_history` where `style_en_name`=#{styleName} and `is_pass`=1 order by `gmt_modified` desc
        </if>
    </select>

    <update id="updateStyleThanks" parameterType="java.util.Map" >
        <if test="thankMap!=null and thankMap.size()>0">
            update `style_history`
            <trim prefix="set" suffixOverrides=",">
                <trim prefix="thanks = case" suffix="end,">
                    <foreach collection="thankMap.entrySet()" index="id" item="t">
                        <if test="id != '' and id != null">
                            when id=#{id} then #{t}
                        </if>
                    </foreach>
                </trim>
            </trim>
            where
            <foreach collection="thankMap.entrySet()" index="id" item="t" separator="or" open="(" close=")">
                (id=#{id} and thanks!=#{t})
            </foreach>
        </if>
    </update>

    <select id="getTodayAuditVersion">
        select count(*) from style_history where date(gmt_created) = curdate() and `auditor_id` is not null;
    </select>

    <select id="getTodayYouAuditVersion">
        select count(*) from style_history where date(gmt_created) = curdate() and `auditor_id`=#{id};
    </select>
</mapper>