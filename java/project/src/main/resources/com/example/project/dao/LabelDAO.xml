<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project.dao.LabelDAO">
    <resultMap id="labelResultMap" type="com.example.project.dataobject.LabelDO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="profile" property="profile"/>
        <result column="picture" property="picture"/>
        <result column="parent_id" property="parentId"/>
        <result column="parent_name" property="parentName"/>
        <result column="official" property="official"/>
        <result column="contact" property="contact"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <select id="search" resultMap="labelResultMap">
        select distinct l1.*
        <if test="keyword != null">
            ,match(l1.`profile`) against (#{keyword} in boolean mode) as res1
            ,match(l1.`parent_name`) against (#{keyword} in boolean mode) * 2 as res2
            ,match(l1.`name`) against (#{keyword} in boolean mode) * 3 as res3
        </if>
        from
        label as l1
        <if test="keyword != null">
            ,label as l2
        </if>
        <where>
            <if test="keyword != null">
                match(l1.`name`, l1.`parent_name`, l1.`profile`) against (#{keyword} in boolean mode)
                or l1.parent_id = l2.id
            </if>
        </where>
        order by
        l1.name
        <if test="keyword != null">
            ,res3 desc
            ,res2 desc
            ,res1 desc
        </if>
    </select>

    <select id="getLabelById" resultMap="labelResultMap">
        <if test="id != null">
            select * from `label` where id = #{id}
        </if>
    </select>

    <select id="getChildrenById" resultMap="labelResultMap">
        <if test="id != null">
            select * from `label` where parent_id = #{id}
        </if>
    </select>

    <select id="getLabelsByIds" resultMap="labelResultMap">
        <if test="ids!=null and ids.size()>0">
            SELECT * FROM `label` where id in
            <foreach collection="ids" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
    </select>

    <update id="updateLabel" parameterType="com.example.project.dataobject.LabelDO">
        <if test="id!=null">
            update `label`
            <set>
                <if test="name!=null">
                    name=#{name},
                </if>
                <if test="profile!=null">
                    profile=#{profile},
                </if>
                <if test="picture!=null">
                    picture=#{picture},
                </if>
                <if test="parentId!=null">
                    parent_id=#{parentId},
                </if>
                <if test="parentName!=null">
                    parent_name=#{parentName},
                </if>
                <if test="official!=null">
                    official=#{official},
                </if>
                <if test="contact!=null">
                    contact=#{contact},
                </if>
            </set>
            <where>
                id = #{id};
            </where>
        </if>
    </update>

    <insert id="addLabel" parameterType="com.example.project.dataobject.LabelDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `label`(`name`,`profile`,`picture`,`parent_id`,`parent_name`,`official`,`contact`)
        VALUES (#{name},#{profile},#{picture},#{parentId},#{parentName},#{official},#{contact});
    </insert>
</mapper>