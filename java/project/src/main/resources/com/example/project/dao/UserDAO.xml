<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project.dao.UserDAO">
    <resultMap id="userResultMap" type="com.example.project.dataobject.UserDO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="password" property="password"/>
        <result column="mail" property="mail"/>
        <result column="follow" property="follow"/>
        <result column="fan" property="fan"/>
        <result column="description" property="description"/>
        <result column="contribute_point" property="contributePoint"/>
        <result column="avatar" property="avatar"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <resultMap type="Map" id="userContributeMap">
        <result column="id" property="id"/>
        <result column="change" property="change"/>
        <result column="audit_time" property="auditTime"/>
        <result column="area_id" property="areaId"/>
        <result column="area_name" property="areaName"/>
        <result column="area" property="area"/>
    </resultMap>

    <resultMap type="Map" id="friendMap">
        <result column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="contribute_point" property="contributePoint"/>
        <result column="avatar" property="avatar"/>
    </resultMap>

    <select id="getUserById" resultMap="userResultMap">
        <if test="userId != null">
            select * from `user` where id = #{userId}
        </if>
    </select>

    <select id="getUserByMailAdd" resultMap="userResultMap">
        <if test="mail != null">
            select * from `user` where mail = #{mail}
        </if>
    </select>

    <insert id="addUser" parameterType="com.example.project.dataobject.UserDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `user`(`name`,`password`,`mail`)
        VALUES (#{name},#{password},#{mail});
    </insert>

    <select id="getUserContribute" resultMap="userContributeMap">
        <if test="userId!=null">
            SELECT id, `change`, `audit_time`, style_id as area_id, style_en_name as area_name, "styles" as area
            FROM `style_history`
            WHERE user_id=#{userId} and `is_pass`=1

            UNION ALL

            SELECT id, `change`, `audit_time`, label_id as area_id, label_name as area_name, "labels" as area
            FROM `label_history`
            WHERE user_id=#{userId} and `is_pass`=1

            UNION ALL

            SELECT id, `change`, `audit_time`, artist_id as area_id, artist_name as area_name, "artists" as area
            FROM `artist_history`
            WHERE user_id=#{userId} and `is_pass`=1

            UNION ALL

            SELECT id, `change`, `audit_time`, release_id as area_id, title as area_name, "releases" as area
            FROM `release_history`
            WHERE user_id=#{userId} and `is_pass`=1

            order by audit_time desc
        </if>

    </select>

    <select id="getFriendList" parameterType="java.util.List" resultMap="friendMap">
        <if test="ids != null and ids.size()>0">
            select `id`, `name`, `description`, `avatar` from `user` where id in
            <foreach collection="ids" item="id" separator=", " open="(" close=")">
                #{id}
            </foreach>
        </if>
    </select>

    <update id="updateContributePoint" parameterType="java.util.Map" >
        <if test="userMap!=null and userMap.size()>0">
            update `user`
            <trim prefix="set" suffixOverrides=",">
                <trim prefix="contribute_point = case" suffix="end,">
                    <foreach collection="userMap.entrySet()" index="id" item="i">
                        <if test="id != '' and id != null">
                            when id=#{id} then #{i}
                        </if>
                    </foreach>
                </trim>
            </trim>
        </if>
    </update>

    <update id="updateFollow" parameterType="java.util.Map" >
        <if test="followMap!=null and followMap.size()>0">
            update `user`
            <trim prefix="set" suffixOverrides=",">
                <trim prefix="follow = case" suffix="end,">
                    <foreach collection="followMap.entrySet()" index="id" item="i">
                        <if test="id != '' and id != null">
                            when id=#{id} then #{i}
                        </if>
                    </foreach>
                </trim>
            </trim>
        </if>
    </update>

    <update id="updateFan" parameterType="java.util.Map" >
        <if test="fanMap!=null and fanMap.size()>0">
            update `user`
            <trim prefix="set" suffixOverrides=",">
                <trim prefix="fan = case" suffix="end,">
                    <foreach collection="fanMap.entrySet()" index="id" item="i">
                        <if test="id != '' and id != null">
                            when id=#{id} then #{i}
                        </if>
                    </foreach>
                </trim>
            </trim>
        </if>
    </update>

    <update id="updateUser" parameterType="com.example.project.dataobject.UserDO">
        update `user`
        <set>
            <if test="name!=null">
                `name`=#{name},
            </if>
            <if test="password!=null">
                `password`=#{password},
            </if>
            <if test="description!=null">
                `description`=#{description},
            </if>
            <if test="avatar!=null">
                `avatar`=#{avatar},
            </if>
        </set>
        where `id`=#{id}
    </update>
</mapper>