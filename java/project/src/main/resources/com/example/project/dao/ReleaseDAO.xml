<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project.dao.ReleaseDAO">
    <resultMap id="releaseResultMap" type="com.example.project.dataobject.ReleaseDO">
        <id column="id" property="id"/>
        <result column="main_id" property="mainId"/>
        <result column="title" property="title"/>
        <result column="artist" property="artist"/>
        <result column="picture" property="picture"/>
        <result column="release_label" property="releaseLabel"/>
        <result column="format" property="format"/>
        <result column="form" property="form"/>
        <result column="country" property="country"/>
        <result column="release_date" property="releaseDate"/>
        <result column="genre" property="genre"/>
        <result column="style" property="style"/>
        <result column="tracklist" property="tracklist"/>
        <result column="credits" property="credits"/>
        <result column="supplement" property="supplement"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <select id="search" resultMap="releaseResultMap">
        select *
        <if test="keyword != null">
            ,match(`title`) against (#{keyword} in boolean mode) as res1
            ,lower(JSON_EXTRACT(`release`.artist,'$[*].name')) like CONCAT('%',lower(#{keyword}),'%') as res2
            ,lower(JSON_EXTRACT(`release`.tracklist, '$[*].extraartists[*].name')) like CONCAT('%',lower(#{keyword}),'%') as res3
            ,lower(JSON_EXTRACT(`release`.credits,'$[*].name')) like CONCAT('%',lower(#{keyword}),'%') as res4
        </if>
        from `release`
        <where>
            1 = 1
            <if test="keyword != null">
                and (match(`title`) against (#{keyword} in boolean mode)
                or lower(JSON_EXTRACT(`release`.artist,'$[*].name')) like CONCAT('%',lower(#{keyword}),'%')
                or lower(JSON_EXTRACT(`release`.tracklist, '$[*].extraartists[*].name')) like CONCAT('%',lower(#{keyword}),'%')
                or lower(JSON_EXTRACT(`release`.credits,'$[*].name')) like CONCAT('%',lower(#{keyword}),'%'))
            </if>
            <if test="genre != null">
                and
                <foreach collection="genre" item="g" open="(" separator="or" close=")">
                    #{g} member of (JSON_EXTRACT(`release`.genre, '$[*]'))
                </foreach>
            </if>
            <if test="style != null">
                and
                <foreach collection="style" item="s" open="(" separator="or" close=")">
                    #{s} member of (JSON_EXTRACT(`release`.style, '$[*]'))
                </foreach>
            </if>
            <if test="format != null">
                and
                <foreach collection="format" item="f" open="(" separator="or" close=")">
                    format = #{f}
                </foreach>
            </if>
            <if test="form != null">
                and
                <foreach collection="form" item="f" open="(" separator="or" close=")">
                    form = #{f}
                </foreach>
            </if>
            <if test="country != null">
                and
                <foreach collection="country" item="c" open="(" separator=" or " close=")">
                    country = #{c}
                </foreach>
            </if>
            <if test="decadeMap != null">
                and
                <foreach collection="decadeMap.entrySet()" index="start" item="end" open="(" separator=" or " close=")">
                    release_date between #{start} and #{end}
                </foreach>
            </if>
        </where>
        <if test="keyword != null">
            order by
            res1 desc,
            res2 desc,
            res3 desc,
            res4 desc
        </if>
    </select>

    <select id="getReleaseById" resultMap="releaseResultMap">
        <if test="id != null">
            select * from `release` where id = #{id}
        </if>
    </select>

    <select id="getReleasesByIds" resultMap="releaseResultMap">
        <if test="ids!=null and ids.size()>0">
            SELECT * FROM `release` where id in
            <foreach collection="ids" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
    </select>

    <select id="getReleaseVersions" resultMap="releaseResultMap">
        <if test="mainId != null">
            select * from `release` where main_id = #{mainId}
        </if>
    </select>

    <select id="getArtistRelease" resultMap="releaseResultMap">
        <if test="artistId != null">
            select id,title,picture,release_label,format,form,release_date from `release` where #{artistId} member of (JSON_EXTRACT(`release`.artist,'$[*].id'))
        </if>
    </select>

    <select id="getArtistFeatured" resultMap="releaseResultMap">
        <if test="artistId != null">
            select id,title,picture,release_label,format,form,release_date from `release` where #{artistId} member of (JSON_EXTRACT(`release`.tracklist, '$[*].extraartists[*].id'))
        </if>
    </select>

    <select id="getArtistBehind" resultMap="releaseResultMap">
        <if test="artistId != null">
            select id,title,picture,release_label,format,form,release_date from `release` where #{artistId} member of (JSON_EXTRACT(`release`.credits,'$[*].id'))
        </if>
    </select>

    <select id="getArtistReleasesCount" resultType="java.lang.Integer">
        <if test="artistId != null">
            select count(*) from `release` where #{artistId} member of (JSON_EXTRACT(`release`.artist,'$[*].id'))
        </if>
    </select>

    <select id="getArtistFeaturedCount" resultType="java.lang.Integer">
        <if test="artistId != null">
            select count(*) from `release` where #{artistId} member of (JSON_EXTRACT(`release`.tracklist, '$[*].extraartists[*].id'))
        </if>
    </select>

    <select id="getArtistBehindCount" resultType="java.lang.Integer">
        <if test="artistId != null">
            select count(*) from `release` where #{artistId} member of (JSON_EXTRACT(`release`.credits,'$[*].id'))
        </if>
    </select>

    <select id="getLabelRelease" resultMap="releaseResultMap">
        <if test="labelId != null">
            select id,title,release_label,artist,picture,format,form,release_date from `release` where #{labelId} member of (JSON_EXTRACT(`release`.release_label, "$[*].id")) order by release_date
        </if>
    </select>

    <update id="updateRelease" parameterType="com.example.project.dataobject.ReleaseDO">
        <if test="id!=null">
            update `release`
            <set>
                <if test="mainId!=null">
                    main_id=#{mainId},
                </if>
                <if test="title!=null">
                    title=#{title},
                </if>
                <if test="artist!=null">
                    artist=#{artist},
                </if>
                <if test="picture!=null">
                    picture=#{picture},
                </if>
                <if test="releaseLabel!=null">
                    release_label=#{releaseLabel},
                </if>
                <if test="format!=null">
                    <if test="format==1 or format==2 or format==3 or format==4 or format==5">
                        format=#{format},
                    </if>
                </if>
                <if test="form!=null">
                    <if test="form==1 or form==2 or form==3 or form==4 or form==5">
                        form=#{form},
                    </if>
                </if>
                <if test="country!=null">
                    country=#{country},
                </if>
                <if test="releaseDate!=null">
                    release_date=#{releaseDate},
                </if>
                <if test="genre!=null">
                    genre=#{genre},
                </if>
                <if test="style!=null">
                    style=#{style},
                </if>
                <if test="tracklist!=null">
                    tracklist=#{tracklist},
                </if>
                <if test="credits!=null">
                    credits=#{credits},
                </if>
                <if test="supplement!=null">
                    supplement=#{supplement}
                </if>
            </set>
            <where>
                id = #{id};
            </where>
        </if>
    </update>

    <insert id="addRelease" parameterType="com.example.project.dataobject.ReleaseDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `release`(`main_id`,`title`,`artist`,`picture`,`release_label`,`format`,`form`,`country`,`release_date`,`genre`,`style`,`tracklist`,`credits`,`supplement`)
        VALUES (#{mainId},#{title},#{artist},#{picture},#{releaseLabel},#{format},#{form},#{country},#{releaseDate},#{genre},#{style},#{tracklist},#{credits},#{supplement});
    </insert>
</mapper>