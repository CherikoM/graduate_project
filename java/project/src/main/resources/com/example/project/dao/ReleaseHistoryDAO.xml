<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project.dao.ReleaseHistoryDAO">
    <resultMap id="releaseHistoryResultMap" type="com.example.project.dataobject.ReleaseHistoryDO">
        <id column="id" property="id"/>
        <result column="is_new" property="isNew"/>
        <result column="release_id" property="releaseId"/>
        <result column="title" property="title"/>
        <result column="change" property="change"/>
        <result column="user_id" property="userId"/>
        <result column="user_name" property="userName"/>
        <result column="info" property="info"/>
        <result column="reference" property="reference"/>
        <result column="auditor_id" property="auditorId"/>
        <result column="is_pass" property="isPass"/>
        <result column="audit_time" property="auditTime"/>
        <result column="thanks" property="thanks"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <insert id="addReleaseVersion" parameterType="com.example.project.dataobject.ReleaseHistoryDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `release_history`(`is_new`,`release_id`,`title`,`change`,`user_id`,`user_name`,`info`,`reference`,`auditor_id`,`is_pass`,`thanks`)
        VALUES (#{isNew},#{releaseId},#{title},#{change},#{userId},#{userName},#{info},#{reference},#{auditorId},#{isPass},#{thanks});
    </insert>

    <select id="getNotAuditReleaseVersion" resultMap="releaseHistoryResultMap">
        select * from `release_history` where is_pass = 0
    </select>

    <select id="isAudit" resultType="Integer">
        <if test="releaseHistoryId!=null">
            select `is_pass` from `release_history` where id=#{releaseHistoryId}
        </if>
    </select>

    <update id="updateReleaseVersion" parameterType="com.example.project.dataobject.ReleaseHistoryDO">
        <if test="id!=null">
            update `release_history`
            <set>
                <if test="releaseId!=null">
                    release_id=#{releaseId},
                </if>
                <if test="auditorId!=null">
                    auditor_id=#{auditorId},
                </if>
                <if test="isPass!=null">
                    <if test="isPass==1 or isPass==2">
                        is_pass=#{isPass},
                    </if>
                </if>
                audit_time=now(),
                <if test="thanks!=null">
                    thanks=#{thanks},
                </if>
            </set>
            <where>
                id = #{id};
            </where>
        </if>
    </update>

    <select id="getAllReleaseVersion" resultMap="releaseHistoryResultMap">
        <if test="releaseId!=null">
            select * from `release_history` where `release_id`=#{releaseId} and `is_pass`=1 order by `gmt_modified` desc
        </if>
    </select>

    <update id="updateReleaseThanks" parameterType="java.util.Map" >
        <if test="thankMap!=null and thankMap.size()>0">
            update `release_history`
            <trim prefix="set" suffixOverrides=",">
                <trim prefix="thanks = case" suffix="end,">
                    <foreach collection="thankMap.entrySet()" index="id" item="t">
                        <if test="id != '' and id != null">
                            when id=#{id} then #{t}
                        </if>
                    </foreach>
                </trim>
            </trim>
            where
            <foreach collection="thankMap.entrySet()" index="id" item="t" separator="or" open="(" close=")">
                (id=#{id} and thanks!=#{t})
            </foreach>
        </if>

    </update>

    <select id="getTodayAuditVersion">
        select count(*) from release_history where date(gmt_created) = curdate() and `auditor_id` is not null;
    </select>

    <select id="getTodayYouAuditVersion">
        select count(*) from release_history where date(gmt_created) = curdate() and `auditor_id`=#{id};
    </select>
</mapper>