<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project.dao.ArtistHistoryDAO">
    <resultMap id="artistHistoryResultMap" type="com.example.project.dataobject.ArtistHistoryDO">
        <id column="id" property="id"/>
        <result column="is_new" property="isNew"/>
        <result column="artist_id" property="artistId"/>
        <result column="artist_name" property="artistName"/>
        <result column="change" property="change"/>
        <result column="user_id" property="userId"/>
        <result column="user_name" property="userName"/>
        <result column="info" property="info"/>
        <result column="reference" property="reference"/>
        <result column="auditor_id" property="auditorId"/>
        <result column="audit_time" property="auditTime"/>
        <result column="thanks" property="thanks"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <insert id="addArtistVersion" parameterType="com.example.project.dataobject.ArtistHistoryDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `artist_history`(`is_new`,`artist_id`,`artist_name`,`change`,`user_id`,`user_name`,`info`,`reference`,`auditor_id`,`is_pass`,`thanks`)
        VALUES (#{isNew},#{artistId},#{artistName},#{change},#{userId},#{userName},#{info},#{reference},#{auditorId},#{isPass},#{thanks});
    </insert>

    <select id="getNotAuditArtistVersion" resultMap="artistHistoryResultMap">
        select * from `artist_history` where is_pass = 0
    </select>

    <select id="isAudit" resultType="Integer">
        <if test="artistHistoryId!=null">
            select `is_pass` from `artist_history` where id=#{artistHistoryId}
        </if>
    </select>

    <update id="updateArtistVersion" parameterType="com.example.project.dataobject.ArtistHistoryDO">
        <if test="id!=null">
            update `artist_history`
            <set>
                <if test="artistId!=null">
                    artist_id=#{artistId},
                </if>
                <if test="auditorId!=null">
                    auditor_id=#{auditorId},
                </if>
                <if test="isPass!=null">
                    <if test="isPass==1 or isPass==2">
                        is_pass=#{isPass},
                    </if>
                </if>
                audit_time=now()
            </set>
            <where>
                id = #{id};
            </where>
        </if>
    </update>

    <select id="getAllArtistVersion" resultMap="artistHistoryResultMap">
        <if test="artistId!=null">
            select * from `artist_history` where `artist_id`=#{artistId} and `is_pass`=1 order by `gmt_modified` desc
        </if>
    </select>

    <update id="updateArtistThanks" parameterType="java.util.Map" >
        <if test="thankMap!=null and thankMap.size()>0">
            update `artist_history`
            <trim prefix="set" suffixOverrides=",">
                <trim prefix="thanks = case" suffix="end,">
                    <foreach collection="thankMap.entrySet()" index="id" item="t">
                        <if test="id != '' and id != null">
                            when id=#{id} then #{t}
                        </if>
                    </foreach>
                </trim>
            </trim>
            where
            <foreach collection="thankMap.entrySet()" index="id" item="t" separator="or" open="(" close=")">
                (id=#{id} and thanks!=#{t})
            </foreach>
        </if>

    </update>

    <select id="getTodayAuditVersion">
        select count(*) from artist_history where date(gmt_created) = curdate() and `auditor_id` is not null;
    </select>

    <select id="getTodayYouAuditVersion">
        select count(*) from artist_history where date(gmt_created) = curdate() and `auditor_id`=#{id};
    </select>
</mapper>